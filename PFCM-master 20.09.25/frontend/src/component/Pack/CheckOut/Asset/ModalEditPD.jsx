import React, { useState, useEffect } from "react";
import QrCodeScannerIcon from "@mui/icons-material/QrCodeScanner";
import { useRef } from "react";
import {
  Dialog,
  DialogContent,
  Box,
  Typography,
  Divider,
  Button,
  Stack,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  IconButton,
  Alert,
  RadioGroup,
  FormControlLabel,
  Radio,
  TextField,
  TableContainer,
  Paper,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody
} from "@mui/material";
import KeyboardIcon from '@mui/icons-material/Keyboard';
import CameraAltIcon from '@mui/icons-material/CameraAlt';
import PrintModal from "./PrintModal";
import CancelIcon from "@mui/icons-material/CancelOutlined";
import CheckCircleIcon from "@mui/icons-material/CheckCircleOutlined";
import HourglassEmptyIcon from "@mui/icons-material/HourglassEmpty";
import { FaCheck } from "react-icons/fa";
import axios from "axios";
axios.defaults.withCredentials = true;
import ModalAlert from "../../../../Popup/AlertSuccess";

const API_URL = import.meta.env.VITE_API_URL;

const QcCheck = ({ open, onClose, material_code, materialName, ptc_time, standard_ptc, heck, cold, rm_cold_status, rm_status, ComeColdDateTime, slot_id,
  tro_id, batch, rmfp_id, onSuccess, Location, ColdOut, operator, level_eu, formattedDelayTime, latestComeColdDate, cooked_date, rmit_date, materials,
  qccheck, sq_remark, mdcheck, md_remark, defect_remark, defectcheck, machine_MD, sq_acceptance, defect_acceptance, dest, weight_RM, tray_count
  , rmm_line_name, withdraw_date, name_edit_prod_two, name_edit_prod_three, first_prod, two_prod, three_prod, qccheck_cold, receiver_qc_cold, approver, production, remark_rework, remark_rework_cold, edit_rework, prepare_mor_night
}) => {

  const [showAlert, setShowAlert] = useState(false);
  const [showPrintModal, setShowPrintModal] = useState(false);
  const [dataForPrint, setDataForPrint] = useState(null);




  // ฟังก์ชันแปลงเวลาจาก UTC เป็นเวลาไทย
  const formatThaiDateTime = (utcDateTimeStr) => {
    if (!utcDateTimeStr) return "-";

    try {
      // สร้าง Date object จาก UTC string
      const utcDate = new Date(utcDateTimeStr);

      // เพิ่ม 7 ชั่วโมงเพื่อแปลงเป็นเวลาไทย (GMT+7)
      // หรือใช้ toLocaleString กับ time zone 'Asia/Bangkok'
      return utcDate.toLocaleString('th-TH', {
        timeZone: 'Asia/Bangkok',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        // second: '2-digit',
        hour12: false
      });
    } catch (error) {
      console.error("Error formatting date:", error);
      return "-";
    }
  };
  //แปลง / เป็น -
  const formatSpecialChars = (value) => {
    if (!value) return "-";
    return value === "/" ? "-" : value;
  };
  // คำนวณระยะเวลาระหว่างสองเวลา (เป็นชั่วโมง)
  const calculateTimeDifference = (startDate, endDate) => {
    if (!startDate || !endDate) return "-";

    try {
      const start = new Date(startDate);
      const end = new Date(endDate);

      start.setSeconds(0, 0);
      end.setSeconds(0, 0);

      console.log("start Time :", start);
      console.log("end :", end);

      // คำนวณความแตกต่างในมิลลิวินาที
      const diffMilliseconds = end - start;

      // แปลงเป็นนาที (1000 มิลลิวินาที = 1 วินาที, 60 วินาที = 1 นาที)
      const diffMinutes = diffMilliseconds / (1000 * 60);

      // แยกเป็นชั่วโมงและนาที
      const hours = Math.floor(diffMinutes / 60);
      const minutes = Math.floor(diffMinutes % 60);

      // เก็บค่าชั่วโมงทศนิยมไว้ใช้ในการคำนวณอื่นๆ ถ้าจำเป็น
      const diffHours = diffMinutes / 60;

      console.log("diffHours :", diffHours);
      console.log("hours:", hours, "minutes:", minutes);

      // สร้างข้อความแสดงผลตามรูปแบบที่ต้องการ
      if (hours > 0) {
        return `${hours} ชม. ${minutes} นาที`;
      } else {
        return `${minutes} นาที`;
      }
    } catch (error) {
      console.error("Error calculating time difference:", error);
      return "-";
    }
  };

  // คำนวณ DBS
  const calculateDBS = (standardPtc, ptcTime) => {
    if (!standardPtc || !ptcTime) return "-";

    try {
      // แปลงเวลาจากรูปแบบ HH.MM เป็นนาที
      const standardParts = standardPtc.toString().split('.');
      const ptcParts = ptcTime.toString().split('.');

      // แปลงชั่วโมงเป็นนาที และรวมกับนาที
      const standardMinutes = parseInt(standardParts[0]) * 60 +
        (standardParts.length > 1 ? parseInt(standardParts[1]) : 0);
      const ptcMinutes = parseInt(ptcParts[0]) * 60 +
        (ptcParts.length > 1 ? parseInt(ptcParts[1]) : 0);

      // คำนวณความแตกต่าง
      let diffMinutes = standardMinutes - ptcMinutes;

      // ถ้าติดลบ ให้แสดงเป็น 0
      if (diffMinutes < 0) diffMinutes = 0;

      // แปลงเป็นชั่วโมงและนาที
      const hours = Math.floor(diffMinutes / 60);
      const minutes = diffMinutes % 60;

      // สร้างข้อความแสดงผล
      if (hours > 0) {
        return `${hours} ชม. ${minutes} นาที`;
      } else {
        return `${minutes} นาที`;
      }
    } catch (error) {
      console.error("Error calculating DBS:", error);
      return "-";
    }
  };

  // คำนวณ DCS (เวลาออกห้องเย็น - เวลาเข้าห้องเย็น)
  const calculateDCS = (comeColdDate, outColdDate) => {
    const timeDiff = calculateTimeDifference(comeColdDate, outColdDate);
    if (timeDiff === "-") return "-";

    return timeDiff;
  };


  // ฟังก์ชันแปลงข้อความเวลาเป็นรูปแบบ HH.MM
  const convertDelayTimeToHHMM = (delayTimeText) => {
    if (!delayTimeText || delayTimeText === "-") return 0;

    // ตรวจสอบว่าเป็นเวลาที่เลยกำหนดหรือเวลาที่เหลือ
    const isExceeded = delayTimeText.includes("เลยกำหนด");

    // แยกข้อความเพื่อดึงวัน ชั่วโมง และนาที
    let timeText = delayTimeText.replace("เลยกำหนด ", "").replace("เหลืออีก ", "");

    let days = 0;
    let hours = 0;
    let minutes = 0;

    // ดึงจำนวนวัน
    if (timeText.includes("วัน")) {
      const daysPart = timeText.split("วัน")[0].trim();
      days = parseInt(daysPart, 10);
      timeText = timeText.split("วัน")[1].trim();
    }

    // ดึงชั่วโมง
    if (timeText.includes("ชม.")) {
      const hoursPart = timeText.split("ชม.")[0].trim();
      hours = parseInt(hoursPart, 10);
      timeText = timeText.split("ชม.")[1].trim();
    }

    // ดึงนาที
    if (timeText.includes("นาที")) {
      const minutesPart = timeText.split("นาที")[0].trim();
      minutes = parseInt(minutesPart, 10);
    }

    // แปลงวันเป็นชั่วโมง และรวมกับชั่วโมงที่มีอยู่
    const totalHours = (days * 24) + hours;

    // แปลงเป็นรูปแบบ HH.MM
    const formattedTime = totalHours + (minutes / 100);

    // ถ้าเป็นเวลาที่เลยกำหนด ให้ใส่เครื่องหมายลบ
    return isExceeded ? -formattedTime : formattedTime;
  };



  const handleScanInputChange = (e) => {
    const value = e.target.value.replace(/\D/g, "").slice(0, 4);
    setScannedCode(value);
    setScanError("");

    // Auto-submit เมื่อครบ 4 หลัก
    if (value.length === 4) {
      setTimeout(() => handleScanVerify(), 100);
    }
  };

  const handleScanKeyPress = (e) => {
    if (e.key === "Enter" && scannedCode.length === 4) {
      handleScanVerify();
    }
  };

  const handleConfirm = async () => {
    const processedMaterials = materials ? materials.map(item => {
      // ตรวจสอบประเภทวัตถุดิบและจัดการกับ delayTime
      if (item.rawMatType === "mixed" && item.delayTime) {
        // แปลง delayTime จากข้อความเป็นตัวเลขในรูปแบบ HH.MM
        const convertedDelayTime = convertDelayTimeToHHMM(item.delayTime);
        return {
          ...item,
          mix_time: convertedDelayTime // เก็บค่าที่แปลงแล้วใน mix_time สำหรับวัตถุดิบผสม
        };
      } else if (item.delayTime && item.remaining_rework_time !== null && item.remaining_rework_time !== undefined) {
        // สำหรับวัตถุดิบที่มี remaining_rework_time
        const convertedDelayTime = convertDelayTimeToHHMM(item.delayTime);
        return {
          ...item,
          rework_delay_time: convertedDelayTime
        };
      } else if (item.delayTime) {
        // กรณีทั่วไปที่มีแค่ delayTime
        const convertedDelayTime = convertDelayTimeToHHMM(item.delayTime);
        return {
          ...item,
          cold: convertedDelayTime
        };
      }
      return item;
    }) : [];

    const payload = {
      mat: material_code,
      rmfpID: rmfp_id ? parseInt(rmfp_id, 10) : null,
      cold: formattedDelayTime,
      ptc_time: ptc_time,
      ColdOut: ColdOut,
      dest: Location,
      operator: operator,
      rm_status: rm_status,
      tro_id: tro_id,
      slot_id: slot_id,
      rm_cold_status: rm_cold_status,
      batch: batch,
      level_eu: level_eu,

      weight_RM: weight_RM,
      tray_count: tray_count,
      rmm_line_name: rmm_line_name,
      materials: processedMaterials.length > 0 ? processedMaterials : materials
    };

    console.log("Sending payload:", JSON.stringify(payload, null, 2));

    try {
      const response = await axios.put(`${API_URL}/api/coldstorage/outcoldstorage`, payload);
      if (response.status === 200) {
        console.log("✅ Data sent successfully:", response.data);
        setDataForPrint({
          material_code,
          materialName,
          batch,
          Location,
          operator,
          ColdOut,
          tro_id,
          slot_id,
          rm_status,
          rm_cold_status,
          ComeColdDateTime: formatThaiDateTime(latestComeColdDate),
          ptc_time,
          cold: formattedDelayTime,
          level_eu,
          qccheck,
          sq_remark,
          mdcheck,
          md_remark,
          defect_remark,
          defectcheck,
          machine_MD,
          cooked_date,
          withdraw_date,
          rmit_date,
          rmm_line_name,
          name_edit_prod_two,
          name_edit_prod_three,
          first_prod,
          two_prod,
          three_prod,
          remark_rework,
          remark_rework_cold,
          edit_rework,
          receiver_qc_cold,
          approver,
          production,
          qccheck_cold,
          prepare_mor_night,
          materials: materials
        });
        setShowPrintModal(true);
        onSuccess();
        onClose();
        setShowAlert(true);
      } else {
        console.error("Error while sending data:", response.status);
      }
    } catch (error) {
      console.error("Error during API call:", error);
    }
  };

  const handleClose = () => {
    onClose();
  };

  return (
    <>
      <Dialog
        open={open}
        onClose={(e, reason) => {
          if (reason === 'backdropClick') return;
          onClose();
        }}
        fullWidth
        maxWidth="xs"
        sx={{
          '@media print': {
            width: 'auto',
            maxWidth: 'none',
            padding: '10px',
          },
        }}
      >
        <DialogContent>
          <Typography variant="h6" style={{ fontSize: "18px", color: "#787878" }} mb={2}>
            กรุณาตรวจสอบข้อมูลก่อนทำรายการ
          </Typography>
          <Divider sx={{ mb: 2 }} />

          <Typography variant="subtitle1" style={{ fontSize: "16px", color: "#505050", marginBottom: "10px" }}>
            รายการวัตถุดิบในรถเข็น: {tro_id}
          </Typography>

          <Box sx={{ mb: 2, maxHeight: 300, overflow: 'auto', border: '1px solid #e0e0e0', borderRadius: '4px', p: 2 }}>
            {materials && materials.length > 0 ? (
              materials.map((item, index) => (
                <Box key={index} sx={{ mb: 3, pb: 2, borderBottom: index < materials.length - 1 ? '1px dashed #ccc' : 'none' }}>
                  <Typography variant="subtitle2" sx={{ fontWeight: 'bold', mb: 1, color: '#2388d1' }}>
                    วัตถุดิบที่ {index + 1}
                  </Typography>
                  <Stack spacing={1}>
                    <Typography color="rgba(0, 0, 0, 0.6)">Batch: {item.batch || '-'}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">Material: {item.material_code}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">รายชื่อวัตถุดิบ: {item.materialName}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">Level EU: {item.levelEu || "-"}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">สถานะวัตถุดิบ: {item.materialStatus}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">เวลาเบิกจากห้องเย็นใหญ่: {formatThaiDateTime(item.withdraw_date || "-")}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">เวลาต้มเสร็จ/อบเสร็จ: {formatThaiDateTime(item.cooked_date || "-")}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">เวลาเตรียมเสร็จ: {formatThaiDateTime(item.rmit_date || "-")}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">เวลาเข้าห้องเย็น (ครั้งที่ 1): {formatThaiDateTime(item.come_cold_date || "-")}</Typography>
                    {item.out_cold_date && (
                      <Typography color="rgba(0, 0, 0, 0.6)">ออกห้องเย็น (ครั้งที่ 1): {formatThaiDateTime(item.out_cold_date)}</Typography>
                    )}
                    {item.come_cold_date && item.out_cold_date && (
                      <Typography color="rgba(0, 0, 0, 0.6)">DCS ครั้งที่ 1: {calculateDCS(item.come_cold_date, item.out_cold_date)}</Typography>
                    )}

                    {item.come_cold_date_two && (
                      <Typography color="rgba(0, 0, 0, 0.6)">เวลาเข้าห้องเย็น (ครั้งที่ 2): {formatThaiDateTime(item.come_cold_date_two)}</Typography>
                    )}
                    {item.out_cold_date_two && (
                      <Typography color="rgba(0, 0, 0, 0.6)">ออกห้องเย็น (ครั้งที่ 2): {formatThaiDateTime(item.out_cold_date_two)}</Typography>
                    )}
                    {item.come_cold_date_two && item.out_cold_date_two && (
                      <Typography color="rgba(0, 0, 0, 0.6)">DCS ครั้งที่ 2: {calculateDCS(item.come_cold_date_two, item.out_cold_date_two)}</Typography>
                    )}


                    {item.come_cold_date_three && (
                      <Typography color="rgba(0, 0, 0, 0.6)">เวลาเข้าห้องเย็น (ครั้งที่ 3): {formatThaiDateTime(item.come_cold_date_three)}</Typography>
                    )}
                    {item.out_cold_date_three && (
                      <Typography color="rgba(0, 0, 0, 0.6)">ออกห้องเย็น (ครั้งที่ 3): {formatThaiDateTime(item.out_cold_date_three)}</Typography>
                    )}
                    {item.come_cold_date_three && item.out_cold_date_three && (
                      <Typography color="rgba(0, 0, 0, 0.6)">DCS ครั้งที่ 3: {calculateDCS(item.come_cold_date_three, item.out_cold_date_three)}</Typography>
                    )}


                    {/* แสดง DBS (เวลาเข้าห้องเย็นล่าสุด - เวลาต้มเสร็จ/อบเสร็จ) */}
                    {item.cooked_date && latestComeColdDate && (
                      <Typography color="rgba(0, 0, 0, 0.6)">DBS เตรียม - เข้า CS: {calculateDBS(item.standard_ptc, item.ptc_time)}</Typography>
                    )}

                    {/* ถ้ามีข้อมูล Delay Time สำหรับแต่ละรายการ ก็แสดงด้วย */}
                    <Typography color="rgba(0, 0, 0, 0.6)">Qc check sensory: {item.qccheck || "-"}</Typography>
                    {/* <Typography color="rgba(0, 0, 0, 0.6)">ยอมรับพิเศษ Sensory: {item.sq_remark || "-"}</Typography> */}

                    {item.sq_remark && item.sq_acceptance === true && (
                      <Typography color="rgba(0, 0, 0, 0.6)">ยอมรับพิเศษ Sensory: {item.sq_remark}</Typography>
                    )}
                    {item.sq_remark && item.sq_acceptance !== true && (
                      <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุ Sensory: {item.sq_remark}</Typography>
                    )}
                    <Typography color="rgba(0, 0, 0, 0.6)">Qc MD check: {item.mdcheck || "-"}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุ MD: {item.md_remark || "-"}</Typography>
                    <Typography color="rgba(0, 0, 0, 0.6)">Qc defect check: {item.defectcheck || "-"}</Typography>
                    {/* <Typography color="rgba(0, 0, 0, 0.6)">ยอมรับพิเศษ Defect: {item.defect_remark || "-"}</Typography> */}
                    {item.defect_remark && item.defect_acceptance === true && (
                      <Typography color="rgba(0, 0, 0, 0.6)">ยอมรับพิเศษ Defect: {item.defect_remark}</Typography>
                    )}
                    {item.defect_remark && item.defect_acceptance !== true && (
                      <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุ Defect: {item.defect_remark}</Typography>
                    )}
                    <Typography color="rgba(0, 0, 0, 0.6)">หมายเลขเครื่อง : {formatSpecialChars(item.machine_MD)}</Typography>


                    {(item.qccheck_cold || item.receiver_qc_cold || item.approver) && (
                      <>
                        <Typography color="black">การตรวจสอบ Sensory ในห้องเย็น</Typography>
                        {item.qccheck_cold && item.qccheck_cold !== "-" && (
                          <Typography color="rgba(0, 0, 0, 0.6)">ผลการตรวจสอบ Sensory : {item.qccheck_cold}</Typography>
                        )}
                        {item.remark_rework_cold && item.remark_rework_cold !== "-" && (
                          <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุไม่ผ่าน : {item.remark_rework_cold}</Typography>
                        )}
                        {item.receiver_qc_cold && item.receiver_qc_cold !== "-" && (
                          <Typography color="rgba(0, 0, 0, 0.6)">ผู้ตรวจ : {item.receiver_qc_cold}</Typography>
                        )}
                        {item.approver && item.approver !== "-" && (
                          <Typography color="rgba(0, 0, 0, 0.6)">ผู้อนุมัติ : {item.approver}</Typography>
                        )}
                      </>
                    )}

                    {item.remark_rework && (

                      <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุแก้ไข-บรรจุ  : {item.remark_rework}</Typography>
                    )}

                    {item.edit_rework && item.edit_rework !== "-" && (
                      <>
                        <Typography color="black">วิธีการที่เคยใช้ในการแก้ไขวัตถุดิบ</Typography>
                        <Typography color="rgba(0, 0, 0, 0.6)">ประวัติการแก้ไข : {item.edit_rework}</Typography>
                      </>
                    )}

                    {(item.first_prod || item.two_prod || item.name_edit_prod_two) && (
                      <>
                        <Typography color="black">วัตถุดิบเคยเปลี่ยนแผนการผลิต</Typography>

                        {item.first_prod && (
                          <Typography color="rgba(0, 0, 0, 0.6)">แผนการผลิต ครั้งที่ 1 : {item.first_prod}</Typography>
                        )}

                        {item.two_prod && (
                          <Typography color="rgba(0, 0, 0, 0.6)">แผนการผลิตใหม่ ครั้งที่ 2 : {item.two_prod}</Typography>
                        )}

                        {item.name_edit_prod_two && (
                          <Typography color="rgba(0, 0, 0, 0.6)">ผู้อนุมัติแก้ไข ครั้งที่ 2 : {item.name_edit_prod_two}</Typography>
                        )}

                        {item.three_prod && (
                          <Typography color="rgba(0, 0, 0, 0.6)">แผนการผลิตใหม่ ครั้งที่ 3 : {item.three_prod}</Typography>
                        )}
                        {item.name_edit_prod_three && (
                          <Typography color="rgba(0, 0, 0, 0.6)">ผู้อนุมัติแก้ไข ครั้งที่ 3 : {item.name_edit_prod_three}</Typography>
                        )}


                      </>
                    )}
                    {/* {item.name_edit_prod && ( */}
                    {item.prepare_mor_night && (<Typography color="rgba(0, 0, 0, 0.6)">เตรียมงานให้กะ : {item.prepare_mor_night}</Typography>)}

                    {/* )} */}
                  </Stack>
                </Box>
              ))
            ) : (
              <Box sx={{ mb: 2 }}>
                <Stack spacing={1}>
                  <Typography color="rgba(0, 0, 0, 0.6)">Batch: {batch}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">Material: {material_code}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">รายชื่อวัตถุดิบ: {materialName}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">Level EU: {level_eu || "-"}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">สถานะวัตถุดิบ: {rm_status}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">เวลาต้มเสร็จ/อบเสร็จ: {formatThaiDateTime(cooked_date) || "-"}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">เวลาเตรียมเสร็จ: {formatThaiDateTime(rmit_date || "-")}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">เวลาเข้าห้องเย็น (ครั้งที่ 1): {formatThaiDateTime(latestComeColdDate || "-")}</Typography>
                  {/* แสดง DBS (เวลาเข้าห้องเย็นล่าสุด - เวลาต้มเสร็จ/อบเสร็จ) */}
                  {cooked_date && latestComeColdDate && (
                    <Typography color="rgba(0, 0, 0, 0.6)">DBS เตรียม - เข้า CS: {calculateDBS(standard_ptc, ptc_time)}</Typography>
                  )}

                  {/* ถ้ามีข้อมูล Delay Time สำหรับแต่ละรายการ ก็แสดงด้วย */}
                  <Typography color="rgba(0, 0, 0, 0.6)">Qc check sensory: {qccheck || "-"}</Typography>
                  {sq_remark && sq_acceptance === true && (
                    <Typography color="rgba(0, 0, 0, 0.6)">ยอมรับพิเศษ Sensory: {sq_remark}</Typography>
                  )}
                  {sq_remark && sq_acceptance !== true && (
                    <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุ Sensory: {sq_remark}</Typography>
                  )}
                  <Typography color="rgba(0, 0, 0, 0.6)">Qc MD check: {mdcheck || "-"}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุ MD: {md_remark || "-"}</Typography>
                  <Typography color="rgba(0, 0, 0, 0.6)">Qc defect check: {defectcheck || "-"}</Typography>
                  {defect_remark && defect_acceptance === true && (
                    <Typography color="rgba(0, 0, 0, 0.6)">ยอมรับพิเศษ Defect: {defect_remark}</Typography>
                  )}
                  {defect_remark && defect_acceptance !== true && (
                    <Typography color="rgba(0, 0, 0, 0.6)">หมายเหตุ Defect: {defect_remark}</Typography>
                  )}
                  <Typography color="rgba(0, 0, 0, 0.6)">หมายเลขเครื่อง : {machine_MD === "/" ? "-" : (machine_MD || "-")}</Typography>
                </Stack>
              </Box>
            )}
          </Box>

          <Divider sx={{ my: 2 }} />

          {/* ข้อมูลทั่วไปของรถเข็น */}
          <Typography variant="subtitle1" style={{ fontSize: "16px", color: "#505050", marginBottom: "10px" }}>
            ข้อมูลทั่วไป
          </Typography>

          <Stack spacing={1}>
            <Typography color="rgba(0, 0, 0, 0.6)">ป้ายทะเบียน: {tro_id}</Typography>
            <Typography color="rgba(0, 0, 0, 0.6)">พื้นที่จอด: {slot_id}</Typography>
            {/* <Typography color="rgba(0, 0, 0, 0.6)">ประเภทการส่งออก: {ColdOut}</Typography> */}
            <Typography color="rgba(0, 0, 0, 0.6)">สถานที่จัดส่ง: {Location}</Typography>
            <Typography color="rgba(0, 0, 0, 0.6)">ไลน์ผลิต: {rmm_line_name || "-"}</Typography>
            <Typography color="rgba(0, 0, 0, 0.6)">ผู้ดำเนินการ: {operator}</Typography>
            <Typography color="rgba(0, 0, 0, 0.6)">สถานะรถเข็นในห้องเย็น: {rm_cold_status}</Typography>
            {/* {prepare_mor_night && prepare_mor_night !== "-" && (
            <Typography color="rgba(0, 0, 0, 0.6)">เตรียมกะ: {prepare_mor_night}</Typography>
            )} */}
          </Stack>

          <Divider sx={{ my: 2 }} />
          <Box sx={{ display: "flex", justifyContent: "space-between" }}>
            <Button
              variant="contained"
              onClick={onClose}
              sx={{
                width: "250px",
                marginBottom: "20px",
                height: "50px",
                margin: "5px",
                backgroundColor: "#ff4444",
                '@media print': {
                  display: 'none',
                },
              }}
            >
              ยกเลิก
            </Button>

            <Button
              id="confirmButton"
              variant="contained"
              onClick={handleConfirm}
              sx={{
                width: "250px",
                height: "50px",
                marginBottom: "20px",
                margin: "5px",
                backgroundColor: "#2388d1",
                '@media print': {
                  display: 'none',
                },
              }}
            >
              ยืนยัน
            </Button>
          </Box>
        </DialogContent>
      </Dialog>

      {showPrintModal && (
        <PrintModal
          open={showPrintModal}
          onClose={() => setShowPrintModal(false)}
          data={{
            material_code,
            materialName,
            batch,
            Location,
            operator,
            ColdOut,
            tro_id,
            slot_id,
            rm_status,
            rm_cold_status,
            ComeColdDateTime: formatThaiDateTime(latestComeColdDate),
            cooked_date,
            withdraw_date,
            rmit_date,
            level_eu,
            rmm_line_name,
            qccheck_cold,
            receiver_qc_cold,
            approver,
            production,
            remark_rework,
            remark_rework_cold,
            edit_rework,
            prepare_mor_night,
            materials: materials
          }}
        />
      )}
      <ModalAlert open={showAlert} onClose={() => setShowAlert(false)} />
    </>
  );
};




const ModalEditPD = ({ open, onClose, data, onSuccess, showModal }) => {
  const [errorMessage, setErrorMessage] = useState("");
  const [materialName, setMaterialName] = useState("");
  const [Location, setLocation] = useState("");
  const [operator, setoperator] = useState("");
  const [isConfirmProdOpen, setIsConfirmProdOpen] = useState(false);
  const [processedMaterials, setProcessedMaterials] = useState([]);
  const [showLocationError, setShowLocationError] = useState(false);
  const [showScanDialog, setShowScanDialog] = useState(true);
  const [isVerified, setIsVerified] = useState(false);
  const [scannedCode, setScannedCode] = useState("");
  const [scanError, setScanError] = useState("");
  const scanInputRef = useRef(null);

  // State สำหรับ QR Scanner
  const [isCameraActive, setIsCameraActive] = useState(true);
  const [isScanning, setIsScanning] = useState(false);
  const qrScannerRef = useRef(null);
  const scannerInstanceRef = useRef(null);

  const {
    batch,
    mat,
    rmfp_id,
    rm_cold_status,
    rm_status,
    tro_id,
    line_name,
    slot_id,
    ComeColdDateTime,
    cold,
    ptc_time,
    standard_ptc,
    batch_after,
    level_eu,
    formattedDelayTime,
    latestComeColdDate,
    sq_remark,
    md_remark,
    defect_remark,
    qccheck,
    mdcheck,
    defectcheck,
    cooked_date,
    withdraw_date,
    rmit_date,
    machine_MD,
    sq_acceptance,
    defect_acceptance,
    rmm_line_name,
    tray_count,
    weight_RM,
    name_edit_prod_two,
    name_edit_prod_three,
    first_prod,
    two_prod,
    three_prod,
    remark_rework,
    remark_rework_cold,
    edit_rework,
    receiver_qc_cold,
    approver,
    production,
    qccheck_cold,
    prepare_mor_night,
    materials = []
  } = data || {};

  // ฟังก์ชันตรวจสอบรหัส
  const handleScanVerify = () => {
    const troIdLast4 = tro_id.slice(-4);

    if (scannedCode === troIdLast4) {
      setScanError("");
      setIsVerified(true);
      setShowScanDialog(false);
      stopCameraScanner();
    } else {
      setScanError(`ป้ายทะเบียนไม่ตรงกับรถเข็น ${tro_id}`);
      setScannedCode("");
    }
  };

  const handleScanInputChange = (e) => {
    const value = e.target.value.replace(/\D/g, "").slice(0, 4);
    setScannedCode(value);
    setScanError("");

    // ปิดกล้องเมื่อเริ่มพิมพ์
    if (value.length > 0 && isCameraActive) {
      stopCameraScanner();
      setIsCameraActive(false);
    }

    if (value.length === 4) {
      setTimeout(() => handleScanVerify(), 100);
    }
  };

  const handleScanKeyPress = (e) => {
    if (e.key === "Enter" && scannedCode.length === 4) {
      handleScanVerify();
    }
  };

  const handleClose = () => {
  stopCameraScanner();
  setShowScanDialog(true);
  setIsVerified(false);
  setScannedCode("");
  setScanError("");
  setIsCameraActive(true);
  setIsScanning(false);

  onClose();
};


  const fetchUserDataFromLocalStorage = () => {
    try {
      const firstName = localStorage.getItem('first_name') || '';
      if (firstName) {
        setoperator(`${firstName}`.trim());
      }
    } catch (error) {
      console.error("Error fetching user data from localStorage:", error);
    }
  };

  // ฟังก์ชันเปิดกล้อง
  const startCameraScanner = () => {
    if (isScanning) return;

    setIsScanning(true);
    setIsCameraActive(true);
    setScanError("");

    setTimeout(() => {
      if (!qrScannerRef.current) return;

      try {
        const Html5Qrcode = window.Html5Qrcode;

        if (!Html5Qrcode) {
          setScanError("ไม่สามารถโหลด QR Scanner ได้ กรุณาพิมพ์เอง");
          setIsScanning(false);
          return;
        }

        scannerInstanceRef.current = new Html5Qrcode("qr-reader");

        scannerInstanceRef.current.start(
          { facingMode: "environment" },   // เปิดกล้องหลังทันที
          {
            fps: 10,
            qrbox: 250
          },
          (decodedText) => {
            const last4 = decodedText.slice(-4).replace(/\D/g, "");

            if (last4.length === 4) {
              setScannedCode(last4);

              if (last4 === tro_id.slice(-4)) {
                setIsVerified(true);
                setShowScanDialog(false);
                stopCameraScanner();
              } else {
                setScanError(`ป้ายทะเบียนไม่ตรงกับรถเข็น ${tro_id}`);
                setScannedCode("");
              }
            }
          },
          (error) => { }
        );
      } catch (e) {
        console.error(e);
        setScanError("ไม่สามารถเปิดกล้องได้ กรุณาพิมพ์เอง");
        setIsScanning(false);
      }
    }, 200);
  };


  // ฟังก์ชันปิดกล้อง
  const stopCameraScanner = () => {
    if (scannerInstanceRef.current) {
      try {
        scannerInstanceRef.current.clear().catch(error => {
          console.error("Error clearing scanner:", error);
        });
      } catch (error) {
        console.error("Error stopping scanner:", error);
      }
      scannerInstanceRef.current = null;
    }
    setIsScanning(false);
  };

  // ฟังก์ชันเปิดกล้องใหม่
  const restartCamera = () => {
    setScannedCode("");
    setScanError("");
    startCameraScanner();
  };

  // useEffect - จัดการเมื่อเปิด dialog
  useEffect(() => {
    if (open) {
      setLocation("");
      setoperator("");
      setShowScanDialog(true);
      setIsVerified(false);
      setScannedCode("");
      setScanError("");
      setIsCameraActive(true);
      setIsScanning(false);
      fetchUserDataFromLocalStorage();

    }

    return () => {
      stopCameraScanner();
    };
  }, [open]);

  useEffect(() => {
    if (mat) {
      fetchMaterialName();
      fetchProduction();
    }
  }, [mat]);

  const fetchMaterialName = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/fetchRawMatName`, { params: { mat } });
      if (response.data.success) {
        setMaterialName(response.data.data[0]?.mat_name || "ไม่พบชื่อวัตถุดิบ");
      } else {
        console.error("Error fetching material name:", response.data.error);
      }
    } catch (error) {
      console.error("Error fetching material name:", error);
    }
  };

  const fetchProduction = async () => {
    try {
      const response = await axios.get(`${API_URL}/api/fetchProduction`, { params: { mat } });
      if (response.data.success) {
        setProduction(response.data.data);
      } else {
        console.error("Error fetching production data:", response.data.error);
      }
    } catch (error) {
      console.error("Error fetching production data:", error);
    }
  };

  const handleConfirm = () => {
    if (!operator || !Location) {
      setErrorMessage("กรุณากรอกข้อมูลให้ครบถ้วน");
      if (!Location) {
        setShowLocationError(true);
      }
    } else {
      setErrorMessage("");
      setShowLocationError(false);

      let processedMaterials = materials;

      if (materials && materials.length > 0) {
        processedMaterials = materials.map(item => {
          if (item.formattedDelayTime !== undefined) {
            return item;
          }

          const individualDelayTime = calculateDelayTimeForItem(item);

          return {
            ...item,
            formattedDelayTime: individualDelayTime,
          };
        });
      }

      setIsConfirmProdOpen(true);
      onClose();
      setProcessedMaterials(processedMaterials);
    }
  };

  const calculateDelayTimeForItem = (item) => {
    if (!item.latestComeColdDate) return formattedDelayTime;

    const coldDate = new Date(item.latestComeColdDate);
    const now = new Date();
    const diffHours = (now - coldDate) / (1000 * 60 * 60);

    return Number((diffHours).toFixed(2));
  };

  const formatSpecialChars = (value) => {
    if (!value) return "-";
    return value === "/" ? "-" : value;
  };

  const handleoperator = (event) => {
    setoperator(event.target.value);
  };

  const handleLocation = (event) => {
    setLocation(event.target.value);
  };

  const formatThaiDateTime = (utcDateTimeStr) => {
    if (!utcDateTimeStr) return "-";

    try {
      const utcDate = new Date(utcDateTimeStr);
      return utcDate.toLocaleString('th-TH', {
        timeZone: 'Asia/Bangkok',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    } catch (error) {
      console.error("Error formatting date:", error);
      return "-";
    }
  };

  const calculateTimeDifference = (startDate, endDate) => {
    if (!startDate || !endDate) return "-";

    try {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const diffMilliseconds = end - start;
      const diffMinutes = diffMilliseconds / (1000 * 60);
      const hours = Math.floor(diffMinutes / 60);
      const minutes = Math.floor(diffMinutes % 60);

      if (hours > 0) {
        return `${hours} ชม. ${minutes} นาที`;
      } else {
        return `${minutes} นาที`;
      }
    } catch (error) {
      console.error("Error calculating time difference:", error);
      return "-";
    }
  };

  const calculateDBS = (standardPtc, ptcTime) => {
    if (!standardPtc || !ptcTime) return "-";

    try {
      const standardParts = standardPtc.toString().split('.');
      const ptcParts = ptcTime.toString().split('.');

      const standardMinutes = parseInt(standardParts[0]) * 60 +
        (standardParts.length > 1 ? parseInt(standardParts[1]) : 0);
      const ptcMinutes = parseInt(ptcParts[0]) * 60 +
        (ptcParts.length > 1 ? parseInt(ptcParts[1]) : 0);

      let diffMinutes = standardMinutes - ptcMinutes;
      if (diffMinutes < 0) diffMinutes = 0;

      const hours = Math.floor(diffMinutes / 60);
      const minutes = diffMinutes % 60;

      if (hours > 0) {
        return `${hours} ชม. ${minutes} นาที`;
      } else {
        return `${minutes} นาที`;
      }
    } catch (error) {
      console.error("Error calculating DBS:", error);
      return "-";
    }
  };

  return (
    <>
      {/* Dialog แรก - สแกนรหัส */}
      <Dialog
        open={open && showScanDialog}
        onClose={(e, reason) => {
          if (reason === 'backdropClick') return;
          handleClose();
        }}
        fullWidth
        maxWidth="sm"
        TransitionProps={{
          onEntered: () => {
            // เปิดกล้องทันทีหลัง modal แสดงเสร็จจริง
            startCameraScanner();
          }
        }}
      >

        <DialogContent>
          <Stack spacing={3} alignItems="center" sx={{ py: 2 }}>
            {/* Icon */}
            <Box sx={{
              fontSize: 60,
              color: scannedCode.length === 4 ? "#4caf50" : "#2388d1",
              transition: "color 0.3s"
            }}>
              <QrCodeScannerIcon sx={{ fontSize: "inherit" }} />
            </Box>

            {/* Header */}
            <Typography variant="h6" align="center" style={{ color: "#787878" }}>
              สแกนป้ายทะเบียนรถเข็น
            </Typography>

            {/* Trolley ID */}
            <Typography variant="body2" align="center" style={{ color: "#787878" }}>
              รถเข็น: <strong>{tro_id}</strong>
            </Typography>

            {/* พื้นที่แสดงกล้อง */}
            <Box sx={{ width: '100%', maxWidth: 400 }}>
              <div
                id="qr-reader"
                ref={qrScannerRef}
                style={{
                  width: '100%',
                  display: isCameraActive ? 'block' : 'none'
                }}
              ></div>

              {!isCameraActive && !isScanning && (
                <Box sx={{
                  textAlign: 'center',
                  py: 2,
                  backgroundColor: '#f5f5f5',
                  borderRadius: 2
                }}>
                  <Typography variant="body2" color="text.secondary" sx={{ mb: 1 }}>
                    กล้องปิดอยู่
                  </Typography>
                  <Button
                    variant="outlined"
                    onClick={restartCamera}
                    startIcon={<CameraAltIcon />}
                    size="small"
                  >
                    เปิดกล้องใหม่
                  </Button>
                </Box>
              )}
            </Box>

            {/* Input Field */}
            <Box sx={{ width: "100%", maxWidth: 350 }}>
              <TextField
                inputRef={scanInputRef}
                fullWidth
                label="หรือพิมพ์เลข 4 หลักท้าย"
                value={scannedCode}
                onChange={handleScanInputChange}
                onKeyPress={handleScanKeyPress}
                placeholder="0000"
                inputProps={{
                  maxLength: 4,
                  style: {
                    fontSize: 24,
                    textAlign: "center",
                    letterSpacing: 8
                  }
                }}
                error={!!scanError}
                onFocus={() => {
                  if (isCameraActive) {
                    stopCameraScanner();
                    setIsCameraActive(false);
                  }
                }}
              />

              {/* Progress Dots */}
              <Box sx={{ display: "flex", justifyContent: "center", gap: 1, mt: 2 }}>
                {[1, 2, 3, 4].map((dot) => (
                  <Box
                    key={dot}
                    sx={{
                      width: 12,
                      height: 12,
                      borderRadius: "50%",
                      backgroundColor: scannedCode.length >= dot ? "#2388d1" : "#e0e0e0",
                      transition: "background-color 0.3s"
                    }}
                  />
                ))}
              </Box>
            </Box>

            {/* Error Message */}
            {scanError && (
              <Alert severity="error" sx={{ width: "100%" }}>
                {scanError}
              </Alert>
            )}

            {/* Helper Text */}
            <Typography variant="caption" style={{ color: "#999" }} align="center">
              สแกน QR Code หรือพิมพ์เลข 4 หลักท้ายของป้ายทะเบียน
            </Typography>

            {/* Buttons */}
            <Box sx={{ display: "flex", gap: 2, width: "100%", mt: 2 }}>
              <Button
                variant="outlined"
                startIcon={<CancelIcon />}
                onClick={handleClose}
                fullWidth
                sx={{
                  color: "#E74A3B",
                  borderColor: "#E74A3B"
                }}
              >
                ยกเลิก
              </Button>

              <Button
                variant="contained"
                startIcon={<CheckCircleIcon />}
                onClick={handleScanVerify}
                disabled={scannedCode.length !== 4}
                fullWidth
                sx={{ backgroundColor: "#41a2e6" }}
              >
                ยืนยัน
              </Button>
            </Box>
          </Stack>
        </DialogContent>
      </Dialog>

      {/* Dialog ที่สอง - ข้อมูลการส่งออก */}
      <Dialog open={open && !showScanDialog && isVerified} onClose={(e, reason) => {
        if (reason === 'backdropClick') return;
        onClose();
      }} fullWidth maxWidth="md">
        <DialogContent>
          <Typography variant="h6" style={{ fontSize: "18px", color: "#787878" }} mb={2}>
            กรุณาระบุข้อมูลในการส่งออก
          </Typography>

          {errorMessage && (
            <Alert severity="error" sx={{ mb: 2 }}>
              {errorMessage}
            </Alert>
          )}

          <Stack spacing={2}>
            <Divider />

            <Typography variant="h6" style={{ fontSize: "16px", color: "#505050" }}>
              รายการวัตถุดิบในรถเข็น: {tro_id}
            </Typography>

            <TableContainer component={Paper}>
              <Table size="small">
                <TableHead>
                  <TableRow>
                    <TableCell>Batch</TableCell>
                    <TableCell>Material</TableCell>
                    <TableCell>รายชื่อวัตถุดิบ</TableCell>
                    <TableCell>Level EU</TableCell>
                    <TableCell>สถานะวัตถุดิบ</TableCell>
                    <TableCell>เวลาเบิกจากห้องเย็นใหญ่</TableCell>
                    <TableCell>เวลาต้มเสร็จ/อบเสร็จ</TableCell>
                    <TableCell>เวลาเตรียมเสร็จ</TableCell>
                    <TableCell>เวลาเข้าห้องเย็น</TableCell>
                    <TableCell>DBS เตรียม - เข้า CS</TableCell>
                    <TableCell>QC Check Sensory</TableCell>
                    <TableCell>หมายเหตุ Sensory </TableCell>
                    <TableCell>MD Check</TableCell>
                    <TableCell>หมายเหตุ MD</TableCell>
                    <TableCell>Defect Check</TableCell>
                    <TableCell>หมายเหตุ Defect</TableCell>
                    <TableCell>หมายเลขเครื่อง</TableCell>
                    <TableCell>แผนผลิตครั้งที่ 1</TableCell>
                    <TableCell>แผนผลิตครั้งที่ 2</TableCell>
                    <TableCell>ผู้อนุมัติแก้ไข 2</TableCell>
                    <TableCell>แผนผลิตครั้งที่ 3</TableCell>
                    <TableCell>ผู้อนุมัติแก้ไข ครั้งที่ 3</TableCell>
                    <TableCell>Sensory เช็คในห้องเย็น</TableCell>
                    <TableCell>หมายเหตุที่ไม่ผ่าน</TableCell>
                    <TableCell>หมายเหตุแก้ไข-บรรจุ</TableCell>
                    <TableCell>ประวัติการแก้ไข</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {materials && materials.length > 0 ? (
                    materials.map((item, index) => (
                      <TableRow key={index}>
                        <TableCell>{item.batch || '-'}</TableCell>
                        <TableCell>{item.material_code}</TableCell>
                        <TableCell>{item.materialName}</TableCell>
                        <TableCell>{item.levelEu || "-"}</TableCell>
                        <TableCell>{item.materialStatus}</TableCell>
                        <TableCell>{formatThaiDateTime(item.withdraw_date) || "-"}</TableCell>
                        <TableCell>{formatThaiDateTime(item.cooked_date) || "-"}</TableCell>
                        <TableCell>{formatThaiDateTime(item.rmit_date) || "-"}</TableCell>
                        <TableCell>{formatThaiDateTime(item.come_cold_date) || "-"}</TableCell>
                        <TableCell>{calculateDBS(item.standard_ptc, item.ptc_time) || "-"}</TableCell>
                        <TableCell>{item.qccheck || "-"}</TableCell>
                        <TableCell>{item.sq_remark || "-"}</TableCell>
                        <TableCell>{item.mdcheck || "-"}</TableCell>
                        <TableCell>{item.md_remark || "-"}</TableCell>
                        <TableCell>{item.defectcheck || "-"}</TableCell>
                        <TableCell>{item.defect_remark || "-"}</TableCell>
                        <TableCell>{formatSpecialChars(item.machine_MD) || "-"}</TableCell>
                        <TableCell>{item.first_prod || "-"}</TableCell>
                        <TableCell>{item.two_prod || "-"}</TableCell>
                        <TableCell>{item.name_edit_prod_two || "-"}</TableCell>
                        <TableCell>{item.three_prod || "-"}</TableCell>
                        <TableCell>{item.name_edit_prod_three || "-"}</TableCell>
                        <TableCell>{item.qccheck_cold || "-"}</TableCell>
                        <TableCell>{item.remark_rework_cold || "-"}</TableCell>
                        <TableCell>{item.remark_rework || "-"}</TableCell>
                        <TableCell>{item.edit_rework || "-"}</TableCell>
                      </TableRow>
                    ))
                  ) : (
                    <TableRow>
                      <TableCell>{batch}</TableCell>
                      <TableCell>{mat}</TableCell>
                      <TableCell>{materialName}</TableCell>
                      <TableCell>{level_eu || "-"}</TableCell>
                      <TableCell>{rm_status}</TableCell>
                      <TableCell>{formatThaiDateTime(withdraw_date || "-")}</TableCell>
                      <TableCell>{formatThaiDateTime(cooked_date || "-")}</TableCell>
                      <TableCell>{formatThaiDateTime(rmit_date || "-")}</TableCell>
                      <TableCell>{formatThaiDateTime(latestComeColdDate || "-")}</TableCell>
                      <TableCell>{calculateDBS(standard_ptc, ptc_time)}</TableCell>
                      <TableCell>{qccheck || "-"}</TableCell>
                      <TableCell>{sq_remark || "-"}</TableCell>
                      <TableCell>{mdcheck || "-"}</TableCell>
                      <TableCell>{md_remark || "-"}</TableCell>
                      <TableCell>{defectcheck || "-"}</TableCell>
                      <TableCell>{defect_remark || "-"}</TableCell>
                      <TableCell>{remark_rework || "-"}</TableCell>
                      <TableCell>{remark_rework_cold || "-"}</TableCell>
                      <TableCell>{edit_rework || "-"}</TableCell>
                      <TableCell>{qccheck_cold || "-"}</TableCell>
                      <TableCell>{formatSpecialChars(machine_MD) || "-"}</TableCell>
                    </TableRow>
                  )}
                </TableBody>
              </Table>
            </TableContainer>

            <Divider />
            <Typography color="rgba(0, 0, 0, 0.6)">เลขรถเข็น: {tro_id}</Typography>
            <Typography color="rgba(0, 0, 0, 0.6)">สถานะรถเข็นในห้องเย็น: {rm_cold_status}</Typography>
            <Typography color="rgba(0, 0, 0, 0.6)">ไลน์ผลิต: {rmm_line_name || "-"}</Typography>
            <Divider />

            <Box sx={{
              paddingLeft: "12px",
              border: showLocationError ? '2px solid red' : 'none',
              borderRadius: showLocationError ? '4px' : '0',
              padding: showLocationError ? '8px' : '0 0 0 12px',
              transition: 'all 0.3s ease'
            }}>
              <Typography style={{ color: "#666", marginRight: "16px" }}>สถานที่จัดส่ง</Typography>
              <RadioGroup row name="location" value={Location} onChange={(e) => {
                handleLocation(e);
                setShowLocationError(false);
              }}>
                {["เหลือจากไลน์ผลิต", "QcCheck"].includes(rm_status) && (
                  <Box sx={{ backgroundColor: '#09af00ff', borderRadius: '4px', padding: '4px 8px', marginRight: '20px' }}>
                    <FormControlLabel
                      value="บรรจุ"
                      control={
                        <Radio
                          sx={{
                            color: "#2196f3",
                            '&.Mui-checked': { color: "#1976d2" },
                          }}
                        />
                      }
                      label={
                        <Box display="flex" alignItems="center" gap={0.5}>
                          <Typography sx={{ color: "#333", fontWeight: 500 }}>บรรจุ</Typography>
                        </Box>
                      }
                    />
                  </Box>
                )}

                {["QcCheck รอกลับมาเตรียม", "รอ Qc", "QcCheck รอ MD", "รอกลับมาเตรียม"].includes(rm_status) && (
                  <Box sx={{ backgroundColor: '#ff0000ff', borderRadius: '4px', padding: '4px 8px' }}>
                    <Box display="flex" alignItems="center" gap={0.5}>
                      <Typography sx={{ color: "#ffffffff", fontWeight: 500 }}>ไม่สามารถจัดส่งไปบรรจุได้</Typography>
                    </Box>
                  </Box>
                )}

                {["รอแก้ไข"].includes(rm_status) && ["เหลือจากไลน์ผลิต", "วัตถุดิบตรง"].includes(rm_cold_status) && remark_rework_cold === null && (
                  <Box sx={{ backgroundColor: '#ff0000ff', borderRadius: '4px', padding: '4px 8px' }}>
                    <FormControlLabel
                      value="จุดเตรียม"
                      control={
                        <Radio
                          sx={{
                            color
                              : "#2196f3",
                            '&.Mui-checked': { color: "#1976d2" },
                          }}
                        />
                      }
                      label={
                        <Box display="flex" alignItems="center" gap={0.5}>
                          <Typography sx={{ color: "#ffffffff", fontWeight: 500 }}>จุดเตรียม</Typography>
                        </Box>
                      }
                    />
                  </Box>
                )}

                {["รอแก้ไข"].includes(rm_status) && ["เหลือจากไลน์ผลิต", "วัตถุดิบตรง"].includes(rm_cold_status) && remark_rework_cold !== null && (
                  <Box sx={{ backgroundColor: '#09af00ff', borderRadius: '4px', padding: '4px 8px' }}>
                    <FormControlLabel
                      value="บรรจุ"
                      control={
                        <Radio
                          sx={{
                            color: "#2196f3",
                            '&.Mui-checked': { color: "#1976d2" },
                          }}
                        />
                      }
                      label={
                        <Box display="flex" alignItems="center" gap={0.5}>
                          <Typography sx={{ color: "#333", fontWeight: 500 }}>บรรจุ</Typography>
                        </Box>
                      }
                    />
                  </Box>
                )}
              </RadioGroup>
            </Box>

            <Divider />
            <TextField
              label="ผู้ส่งออก"
              variant="outlined"
              fullWidth
              value={operator}
              onChange={handleoperator}
              InputProps={{
                readOnly: true,
              }}
            />

            <Box display="flex" justifyContent="flex-end" gap={2} mt={2}>
              <Button
                variant="outlined"
                startIcon={<CancelIcon />}
                onClick={onClose}
                sx={{
                  color: "#E74A3B",
                  borderColor: "#E74A3B",
                  '&:hover': {
                    borderColor: "#C0392B",
                    backgroundColor: "rgba(231, 74, 59, 0.04)"
                  }
                }}
              >
                ยกเลิก
              </Button>
              <Button
                variant="contained"
                startIcon={<CheckCircleIcon />}
                onClick={handleConfirm}
                sx={{
                  backgroundColor: "#41a2e6",
                  '&:hover': {
                    backgroundColor: "#2196f3"
                  }
                }}
              >
                ยืนยัน
              </Button>
            </Box>
          </Stack>
        </DialogContent>
      </Dialog>

      {/* Dialog ยืนยันการส่งออก */}
      {isConfirmProdOpen && (
        <ConfirmProdDialog
          open={isConfirmProdOpen}
          onClose={() => {
            setIsConfirmProdOpen(false);
            showModal();
          }}
          onSuccess={() => {
            setIsConfirmProdOpen(false);
            onSuccess();
          }}
          data={{
            ...data,
            materials: processedMaterials,
            operator,
            Location
          }}
        />
      )}
    </>
  );
};

export default ModalEditPD;